<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Little Woo - Joanne's Momentum Growth Plan</title>
<style>
/* ============ RESET & BASE ============ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --dark-sage: #34493d;
  --dusty-teal: #bdd1ce;
  --soft-gold: #ded9a7;
  --warm-cream: #f6eee4;
  --near-black: #111111;
  --white: #ffffff;
  --card-shadow: 0 2px 8px rgba(0,0,0,0.06);
  --card-border: 1px solid rgba(52,73,61,0.12);
  --radius: 12px;
  --transition: 0.2s ease;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background: var(--warm-cream);
  color: var(--near-black);
  line-height: 1.6;
  font-size: 15px;
  padding: 0;
  margin: 0;
}

/* ============ LAYOUT ============ */
.page-wrap {
  max-width: 720px;
  margin: 0 auto;
  padding: 32px 20px 60px;
}

.card {
  background: var(--white);
  border: var(--card-border);
  border-radius: var(--radius);
  box-shadow: var(--card-shadow);
  padding: 28px 24px;
  margin-bottom: 20px;
}

/* ============ TYPOGRAPHY ============ */
h1 {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 2rem;
  color: var(--dark-sage);
  font-weight: 700;
  letter-spacing: -0.5px;
}

h2 {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 1.25rem;
  color: var(--dark-sage);
  font-weight: 600;
  margin-bottom: 16px;
}

h3 {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--dark-sage);
  opacity: 0.7;
  margin-bottom: 10px;
  font-weight: 600;
}

.subtitle {
  font-size: 0.95rem;
  color: var(--dark-sage);
  opacity: 0.8;
  margin-top: 4px;
}

/* ============ HEADER ============ */
.header-card {
  text-align: center;
  padding: 36px 24px 28px;
}

.header-card h1 { margin-bottom: 2px; }

/* ============ TIMELINE ============ */
.timeline-section {
  margin-top: 20px;
  text-align: left;
}

.timeline-label-row {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--dark-sage);
  opacity: 0.7;
  margin-bottom: 6px;
  font-weight: 500;
}

.timeline-bar {
  width: 100%;
  height: 10px;
  background: rgba(189,209,206,0.35);
  border-radius: 5px;
  overflow: hidden;
  position: relative;
}

.timeline-fill {
  height: 100%;
  background: var(--dusty-teal);
  border-radius: 5px;
  transition: width 0.4s ease;
  min-width: 2%;
}

.timeline-markers {
  display: flex;
  justify-content: space-between;
  margin-top: 6px;
  font-size: 0.7rem;
  color: var(--dark-sage);
  opacity: 0.55;
}

.timeline-markers span {
  text-align: center;
  flex: 1;
}

/* ============ PRIVATE BROWSING WARNING ============ */
.private-warning {
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 20px;
  font-size: 0.85rem;
  color: #856404;
  text-align: center;
  display: none;
}

/* ============ CHECKBOXES ============ */
.task-row {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}

.task-row:last-child { border-bottom: none; }

.task-row label {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  cursor: pointer;
  flex: 1;
  font-size: 0.93rem;
  line-height: 1.5;
  padding: 2px 0;
}

.task-row input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  min-width: 20px;
  border: 2px solid var(--dusty-teal);
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  margin-top: 2px;
  transition: all var(--transition);
}

.task-row input[type="checkbox"]:checked {
  background: var(--dark-sage);
  border-color: var(--dark-sage);
}

.task-row input[type="checkbox"]:checked::after {
  content: '';
  position: absolute;
  left: 5px;
  top: 2px;
  width: 6px;
  height: 10px;
  border: solid var(--white);
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.task-row.completed label span {
  text-decoration: line-through;
  opacity: 0.5;
}

/* ============ DAY CHECKBOXES (Substack Notes) ============ */
.day-checkboxes {
  display: flex;
  gap: 6px;
  margin-top: 6px;
  margin-bottom: 4px;
  flex-wrap: wrap;
}

.day-check {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
}

.day-check span {
  font-size: 0.7rem;
  color: var(--dark-sage);
  opacity: 0.6;
  font-weight: 600;
}

.day-check input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  width: 28px;
  height: 28px;
  border: 2px solid var(--dusty-teal);
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  transition: all var(--transition);
}

.day-check input[type="checkbox"]:checked {
  background: var(--dark-sage);
  border-color: var(--dark-sage);
}

.day-check input[type="checkbox"]:checked::after {
  content: '';
  position: absolute;
  left: 8px;
  top: 4px;
  width: 7px;
  height: 11px;
  border: solid var(--white);
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

/* ============ COUNTER ============ */
.counter-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}

.counter-row:last-child { border-bottom: none; }

.counter-label {
  flex: 1;
  font-size: 0.93rem;
}

.counter-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.counter-btn {
  width: 30px;
  height: 30px;
  border-radius: 8px;
  border: 1.5px solid var(--dusty-teal);
  background: var(--white);
  color: var(--dark-sage);
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all var(--transition);
  line-height: 1;
}

.counter-btn:hover {
  background: var(--soft-gold);
  border-color: var(--soft-gold);
}

.counter-val {
  font-size: 1rem;
  font-weight: 600;
  color: var(--dark-sage);
  min-width: 20px;
  text-align: center;
}

.counter-aim {
  font-size: 0.75rem;
  color: var(--dark-sage);
  opacity: 0.5;
}

/* ============ ADD TASK ============ */
.add-task-row {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  padding-top: 8px;
}

.add-task-input {
  flex: 1;
  border: 1.5px solid rgba(189,209,206,0.6);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 0.88rem;
  font-family: inherit;
  background: var(--warm-cream);
  color: var(--near-black);
  transition: border-color var(--transition);
  outline: none;
}

.add-task-input:focus {
  border-color: var(--dark-sage);
}

.add-task-input::placeholder {
  color: rgba(52,73,61,0.4);
}

.add-task-btn {
  border: none;
  background: var(--dusty-teal);
  color: var(--dark-sage);
  font-size: 0.82rem;
  font-weight: 600;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}

.add-task-btn:hover {
  background: var(--soft-gold);
}

/* ============ STATS ============ */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 2px;
  margin-top: 8px;
}

.stats-header {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--dark-sage);
  text-align: center;
  padding: 8px 4px;
  background: rgba(189,209,206,0.2);
  border-radius: 6px 6px 0 0;
}

.stats-label {
  font-size: 0.82rem;
  padding: 10px 8px;
  display: flex;
  align-items: center;
  background: rgba(189,209,206,0.08);
  border-bottom: 1px solid rgba(0,0,0,0.04);
}

.stats-input-cell {
  padding: 6px 4px;
  text-align: center;
  background: rgba(189,209,206,0.04);
  border-bottom: 1px solid rgba(0,0,0,0.04);
}

.stats-input {
  width: 100%;
  max-width: 90px;
  border: 1.5px solid rgba(189,209,206,0.5);
  border-radius: 6px;
  padding: 6px 8px;
  font-size: 0.88rem;
  font-family: inherit;
  text-align: center;
  background: var(--white);
  color: var(--near-black);
  outline: none;
  transition: border-color var(--transition);
}

.stats-input:focus {
  border-color: var(--dark-sage);
}

/* Stats table layout for better alignment */
.stats-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  margin-top: 8px;
}

.stats-table th {
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--dark-sage);
  text-align: center;
  padding: 10px 8px;
  background: rgba(189,209,206,0.15);
}

.stats-table th:first-child {
  text-align: left;
  border-radius: 8px 0 0 0;
}

.stats-table th:last-child {
  border-radius: 0 8px 0 0;
}

.stats-table td {
  padding: 8px;
  border-bottom: 1px solid rgba(0,0,0,0.04);
  font-size: 0.88rem;
}

.stats-table td:first-child {
  font-weight: 500;
  color: var(--near-black);
}

.stats-table td:not(:first-child) {
  text-align: center;
}

/* ============ COLLAPSIBLE ============ */
.collapsible-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 4px 0;
  user-select: none;
}

.collapsible-header h3 {
  margin-bottom: 0;
}

.collapse-icon {
  font-size: 0.8rem;
  color: var(--dark-sage);
  opacity: 0.5;
  transition: transform var(--transition);
}

.collapsible-body {
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  max-height: 600px;
  opacity: 1;
}

.collapsible-body.collapsed {
  max-height: 0;
  opacity: 0;
}

/* ============ CUSTOM TASK DELETE ============ */
.custom-task-delete {
  background: none;
  border: none;
  color: rgba(52,73,61,0.3);
  font-size: 1rem;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  transition: all var(--transition);
  line-height: 1;
}

.custom-task-delete:hover {
  color: #c0392b;
  background: rgba(192,57,43,0.08);
}

/* ============ BUTTONS ============ */
.footer-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
}

.btn-primary {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: var(--dark-sage);
  color: var(--white);
  border: none;
  border-radius: 10px;
  padding: 14px 28px;
  font-size: 0.95rem;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  width: 100%;
  max-width: 320px;
}

.btn-primary:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

.btn-secondary {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: var(--white);
  color: var(--dark-sage);
  border: 1.5px solid var(--dusty-teal);
  border-radius: 10px;
  padding: 12px 24px;
  font-size: 0.88rem;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  width: 100%;
  max-width: 320px;
}

.btn-secondary:hover {
  background: var(--soft-gold);
  border-color: var(--soft-gold);
}

.btn-danger {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: none;
  color: var(--dark-sage);
  border: none;
  border-radius: 10px;
  padding: 10px 24px;
  font-size: 0.82rem;
  font-weight: 500;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  opacity: 0.6;
}

.btn-danger:hover {
  opacity: 1;
  color: #c0392b;
}

/* ============ TOAST ============ */
.toast {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--dark-sage);
  color: var(--white);
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 0.88rem;
  font-weight: 500;
  opacity: 0;
  pointer-events: none;
  transition: all 0.3s ease;
  z-index: 1000;
}

.toast.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

/* ============ CONFIRM DIALOG ============ */
.dialog-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
  padding: 20px;
}

.dialog-overlay.active {
  display: flex;
}

.dialog-box {
  background: var(--white);
  border-radius: var(--radius);
  padding: 28px 24px;
  max-width: 360px;
  width: 100%;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
  text-align: center;
}

.dialog-box h3 {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 1.1rem;
  text-transform: none;
  letter-spacing: 0;
  opacity: 1;
  margin-bottom: 8px;
}

.dialog-box p {
  font-size: 0.88rem;
  opacity: 0.7;
  margin-bottom: 20px;
}

.dialog-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.dialog-buttons button {
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 0.88rem;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
}

.dialog-cancel {
  background: none;
  border: 1.5px solid var(--dusty-teal);
  color: var(--dark-sage);
}

.dialog-cancel:hover {
  background: rgba(189,209,206,0.2);
}

.dialog-confirm {
  background: var(--dark-sage);
  border: none;
  color: var(--white);
}

.dialog-confirm:hover {
  opacity: 0.9;
}

/* ============ SECTION DIVIDER ============ */
.pillar-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--dusty-teal);
  font-weight: 700;
  margin-bottom: 4px;
}

/* ============ RESPONSIVE ============ */
@media (max-width: 600px) {
  .page-wrap { padding: 20px 14px 50px; }
  .card { padding: 20px 16px; }
  h1 { font-size: 1.6rem; }
  h2 { font-size: 1.1rem; }

  .stats-table td, .stats-table th { padding: 6px 4px; font-size: 0.8rem; }
  .stats-input { max-width: 70px; padding: 5px 4px; font-size: 0.82rem; }

  .day-checkboxes { gap: 4px; }
  .day-check input[type="checkbox"] { width: 32px; height: 32px; }
  .day-check input[type="checkbox"]:checked::after { left: 9px; top: 5px; width: 8px; height: 12px; }

  .btn-primary, .btn-secondary { max-width: 100%; }
  .ecosystem-circle { width: 240px; height: 240px; }
  .eco-node { padding: 5px 10px; font-size: 0.68rem; }
  .card-row { grid-template-columns: 1fr; gap: 0; }
  .card-row > .card { margin-bottom: 20px; }
}

/* ============ PROMPT BUTTONS ============ */
.prompt-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--white);
  color: var(--dark-sage);
  border: 1.5px solid var(--dusty-teal);
  border-radius: 8px;
  padding: 8px 14px;
  font-size: 0.82rem;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  margin-top: 10px;
}
.prompt-btn:hover {
  background: var(--soft-gold);
  border-color: var(--soft-gold);
}
.prompt-btn::before {
  content: '\1F4CB';
  font-size: 0.9rem;
}

/* ============ ESSAY TRACKER ============ */
.essay-tracker-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
  opacity: 0;
  padding: 0;
}
.essay-tracker-panel.open {
  max-height: 400px;
  opacity: 1;
  padding: 12px 0 4px;
}
.essay-tracker-panel .tracker-field {
  margin-bottom: 10px;
}
.essay-tracker-panel .tracker-field > label {
  display: block;
  font-size: 0.82rem;
  color: var(--dark-sage);
  opacity: 0.7;
  margin-bottom: 4px;
  font-weight: 500;
  cursor: default;
}
.essay-tracker-panel input[type="text"] {
  width: 100%;
  border: 1.5px solid rgba(189,209,206,0.6);
  border-radius: 8px;
  padding: 8px 12px;
  font-size: 0.88rem;
  font-family: inherit;
  background: var(--warm-cream);
  color: var(--near-black);
  outline: none;
  transition: border-color var(--transition);
}
.essay-tracker-panel input[type="text"]:focus {
  border-color: var(--dark-sage);
}

/* ============ STAR RATING ============ */
.star-rating {
  display: flex;
  gap: 4px;
  margin-top: 4px;
}
.star-rating .star {
  font-size: 1.4rem;
  cursor: pointer;
  color: rgba(189,209,206,0.5);
  transition: color var(--transition);
  background: none;
  border: none;
  padding: 0;
  line-height: 1;
}
.star-rating .star.active {
  color: var(--soft-gold);
}
.star-rating .star:hover {
  color: var(--soft-gold);
}
.essay-submit-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--dusty-teal);
  color: var(--dark-sage);
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 0.82rem;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  margin-top: 6px;
}
.essay-submit-btn:hover {
  background: var(--soft-gold);
}

/* ============ ECOSYSTEM VISUAL ============ */
.ecosystem-circle {
  position: relative;
  width: 280px;
  height: 280px;
  margin: 12px auto 8px;
}
.eco-node {
  position: absolute;
  background: var(--white);
  border: 1.5px solid var(--dusty-teal);
  border-radius: 20px;
  padding: 7px 14px;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--dark-sage);
  text-align: center;
  white-space: nowrap;
  z-index: 2;
}
.eco-node:nth-child(1) { top: 0; left: 50%; transform: translateX(-50%); }
.eco-node:nth-child(2) { top: 22%; right: 0; }
.eco-node:nth-child(3) { top: 58%; right: 2%; }
.eco-node:nth-child(4) { bottom: 0; left: 50%; transform: translateX(-50%); }
.eco-node:nth-child(5) { top: 58%; left: 2%; }
.eco-node:nth-child(6) { top: 22%; left: 0; }
.eco-ring {
  position: absolute;
  inset: 24px;
  border: 1.5px dashed rgba(189,209,206,0.5);
  border-radius: 50%;
}
.eco-center-arrow {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.4rem;
  color: var(--dusty-teal);
  opacity: 0.5;
}

/* ============ SIDE-BY-SIDE CARDS ============ */
.card-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.card-row > .card {
  margin-bottom: 0;
}

/* ============ STATS LOCK ============ */
.stats-lock-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: none;
  border: 1.5px solid rgba(189,209,206,0.5);
  border-radius: 6px;
  padding: 4px 10px;
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--dark-sage);
  opacity: 0.6;
  cursor: pointer;
  transition: all var(--transition);
  font-family: inherit;
}
.stats-lock-btn:hover {
  opacity: 1;
  border-color: var(--dusty-teal);
}
.stats-lock-btn.locked {
  background: rgba(189,209,206,0.15);
  opacity: 0.8;
}
.stats-input.locked {
  background: rgba(189,209,206,0.1);
  color: rgba(17,17,17,0.5);
  pointer-events: none;
  border-color: rgba(189,209,206,0.3);
}
.collapsible-header h2 {
  margin-bottom: 0;
}

/* ============ MODAL ============ */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
  padding: 20px;
}
.modal-overlay.active {
  display: flex;
}
.modal-content {
  background: var(--white);
  border-radius: var(--radius);
  padding: 28px 24px;
  max-width: 500px;
  width: 100%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
}
.modal-content h3 {
  font-family: Georgia, 'Times New Roman', serif;
  font-size: 1.1rem;
  text-transform: none;
  letter-spacing: 0;
  opacity: 1;
  margin-bottom: 16px;
}
.modal-close {
  background: none;
  border: 1.5px solid var(--dusty-teal);
  border-radius: 8px;
  padding: 8px 20px;
  font-size: 0.88rem;
  font-weight: 600;
  font-family: inherit;
  color: var(--dark-sage);
  cursor: pointer;
  transition: all var(--transition);
  margin-top: 16px;
}
.modal-close:hover {
  background: rgba(189,209,206,0.2);
}
/* ============ PROGRESS LOG ============ */
.dialog-box.dialog-wide {
  max-width: 480px;
  text-align: left;
}
.dialog-box.dialog-wide h3 {
  text-align: center;
}
.dialog-box.dialog-wide .dialog-buttons {
  margin-top: 20px;
}
.submit-summary-banner {
  background: rgba(189,209,206,0.2);
  border-radius: 8px;
  padding: 10px 14px;
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--dark-sage);
  text-align: center;
  margin-bottom: 16px;
}
.submit-pillar {
  margin-bottom: 12px;
}
.submit-pillar-name {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--dark-sage);
  opacity: 0.6;
  font-weight: 600;
  margin-bottom: 4px;
}
.submit-pillar-items {
  font-size: 0.85rem;
  line-height: 1.6;
  padding-left: 4px;
}
.submit-pillar-items .item-done {
  opacity: 1;
}
.submit-pillar-items .item-not-done {
  opacity: 0.4;
  text-decoration: line-through;
}
.submit-essay-card {
  background: rgba(222,217,167,0.2);
  border: 1px solid rgba(222,217,167,0.4);
  border-radius: 8px;
  padding: 10px 14px;
  margin-bottom: 12px;
  font-size: 0.85rem;
}
.submit-essay-card .essay-card-title {
  font-weight: 600;
}
.submit-essay-card .essay-card-meta {
  font-size: 0.78rem;
  opacity: 0.6;
  margin-top: 2px;
}
.submit-reflection-label {
  font-size: 0.85rem;
  font-weight: 500;
  margin-bottom: 6px;
  color: var(--dark-sage);
}
.submit-reflection-textarea {
  width: 100%;
  border: 1.5px solid rgba(189,209,206,0.6);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 0.88rem;
  font-family: inherit;
  background: var(--warm-cream);
  color: var(--near-black);
  outline: none;
  transition: border-color var(--transition);
  resize: vertical;
  min-height: 60px;
}
.submit-reflection-textarea:focus {
  border-color: var(--dark-sage);
}
.progress-entry {
  border-bottom: 1px solid rgba(0,0,0,0.06);
  padding: 0;
}
.progress-entry:last-child {
  border-bottom: none;
}
.progress-entry-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  padding: 12px 0;
  user-select: none;
}
.progress-entry-header:hover {
  opacity: 0.8;
}
.progress-entry-date {
  font-weight: 600;
  font-size: 0.93rem;
  color: var(--dark-sage);
}
.progress-entry-arrow {
  font-size: 0.75rem;
  color: var(--dark-sage);
  opacity: 0.5;
  transition: transform var(--transition);
}
.progress-entry.expanded .progress-entry-arrow {
  transform: rotate(90deg);
}
.progress-entry-summary {
  font-size: 0.82rem;
  opacity: 0.6;
  margin-top: -4px;
  padding-bottom: 4px;
}
.progress-entry-reflection {
  font-size: 0.85rem;
  font-style: italic;
  opacity: 0.7;
  padding: 4px 0 8px;
  line-height: 1.5;
}
.progress-entry-essay {
  background: rgba(222,217,167,0.15);
  border-radius: 6px;
  padding: 6px 10px;
  font-size: 0.82rem;
  margin-bottom: 8px;
  display: inline-block;
}
.progress-entry-detail {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  opacity: 0;
}
.progress-entry.expanded .progress-entry-detail {
  max-height: 800px;
  opacity: 1;
  padding-bottom: 12px;
}
.progress-empty {
  font-size: 0.88rem;
  opacity: 0.5;
  text-align: center;
  padding: 24px 0;
  line-height: 1.6;
}

/* ============ CHAT PANEL ============ */
.chat-panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.3s ease, padding 0.3s ease;
  opacity: 0;
  padding: 0;
}
.chat-panel.open {
  max-height: 2000px;
  opacity: 1;
  padding: 14px 0 4px;
}
.chat-header {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 8px;
}
.chat-close-btn {
  background: none;
  border: none;
  font-size: 0.82rem;
  color: var(--dark-sage);
  opacity: 0.5;
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: inherit;
  font-weight: 500;
  transition: all var(--transition);
}
.chat-close-btn:hover {
  opacity: 1;
  background: rgba(189,209,206,0.2);
}
.chat-messages {
  margin-bottom: 12px;
  max-height: 500px;
  overflow-y: auto;
}
.chat-msg {
  margin-bottom: 10px;
  font-size: 0.88rem;
  line-height: 1.6;
}
.chat-msg-user {
  background: rgba(189,209,206,0.18);
  border-radius: 10px;
  padding: 10px 14px;
}
.chat-msg-user .chat-msg-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--dark-sage);
  opacity: 0.5;
  font-weight: 600;
  margin-bottom: 4px;
}
.chat-msg-assistant {
  background: rgba(222,217,167,0.15);
  border: 1px solid rgba(222,217,167,0.3);
  border-radius: 10px;
  padding: 10px 14px;
  position: relative;
}
.chat-msg-assistant .chat-msg-content p {
  margin-bottom: 8px;
}
.chat-msg-assistant .chat-msg-content p:last-child {
  margin-bottom: 0;
}
.chat-msg-assistant .chat-msg-content strong {
  font-weight: 600;
}
.chat-msg-assistant .chat-msg-content em {
  font-style: italic;
}
.chat-copy-btn {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: none;
  border: 1px solid rgba(189,209,206,0.5);
  border-radius: 6px;
  padding: 4px 10px;
  font-size: 0.72rem;
  font-weight: 600;
  color: var(--dark-sage);
  opacity: 0.6;
  cursor: pointer;
  transition: all var(--transition);
  font-family: inherit;
  margin-top: 8px;
}
.chat-copy-btn:hover {
  opacity: 1;
  background: rgba(189,209,206,0.15);
}
.chat-essay-input {
  width: 100%;
  border: 1.5px solid rgba(189,209,206,0.6);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 0.88rem;
  font-family: inherit;
  background: var(--warm-cream);
  color: var(--near-black);
  outline: none;
  transition: border-color var(--transition);
  resize: vertical;
  min-height: 100px;
}
.chat-essay-input:focus {
  border-color: var(--dark-sage);
}
.chat-followup-input {
  width: 100%;
  border: 1.5px solid rgba(189,209,206,0.6);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: 0.88rem;
  font-family: inherit;
  background: var(--warm-cream);
  color: var(--near-black);
  outline: none;
  transition: border-color var(--transition);
  resize: none;
  min-height: 42px;
}
.chat-followup-input:focus {
  border-color: var(--dark-sage);
}
.chat-input-row {
  margin-top: 8px;
}
.chat-send-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--dark-sage);
  color: var(--white);
  border: none;
  border-radius: 8px;
  padding: 9px 18px;
  font-size: 0.82rem;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all var(--transition);
  margin-top: 8px;
}
.chat-send-btn:hover {
  opacity: 0.9;
}
.chat-send-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.chat-loading {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.82rem;
  color: var(--dark-sage);
  opacity: 0.6;
  padding: 8px 0;
}
.chat-loading-dots::after {
  content: '';
  animation: chatDots 1.2s steps(4, end) infinite;
}
@keyframes chatDots {
  0% { content: ''; }
  25% { content: '.'; }
  50% { content: '..'; }
  75% { content: '...'; }
  100% { content: ''; }
}
.chat-cursor {
  display: inline-block;
  width: 2px;
  height: 1em;
  background: var(--dark-sage);
  margin-left: 2px;
  animation: chatBlink 0.7s step-end infinite;
  vertical-align: text-bottom;
}
@keyframes chatBlink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
.chat-error {
  font-size: 0.85rem;
  color: #c0392b;
  padding: 8px 0;
}
.progress-entry-delete {
  background: none;
  border: none;
  font-size: 0.75rem;
  color: var(--dark-sage);
  opacity: 0.35;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  font-family: inherit;
  font-weight: 500;
  transition: all var(--transition);
}
.progress-entry-delete:hover {
  opacity: 1;
  color: #c0392b;
  background: rgba(192,57,43,0.08);
}
.prompt-btn.active {
  background: var(--dark-sage);
  color: var(--white);
  border-color: var(--dark-sage);
}
.prompt-btn.active::before {
  content: '\2715';
}
@media (max-width: 600px) {
  .chat-messages { max-height: 400px; }
  .chat-essay-input { min-height: 80px; }
}
</style>
</head>
<body>

<div class="page-wrap">

  <!-- Private browsing warning -->
  <div class="private-warning" id="privateWarning">
    Heads up: It looks like you might be in a private/incognito window. Your progress won't be saved between sessions. Use a regular browser window so nothing gets lost!
  </div>

  <!-- ============ HEADER ============ -->
  <div class="card header-card">
    <h1>A Little Woo</h1>
    <p class="subtitle">Joanne's Momentum Growth Plan</p>

    <div class="timeline-section">
      <div class="timeline-label-row">
        <span>Jan 21</span>
        <span id="timelinePercent">0%</span>
        <span>Jul 21</span>
      </div>
      <div class="timeline-bar">
        <div class="timeline-fill" id="timelineFill"></div>
      </div>
      <div class="timeline-markers">
        <span>Foundation</span>
        <span>Build</span>
        <span>Grow</span>
        <span>Expand</span>
        <span>Refine</span>
        <span>Revisit</span>
      </div>
    </div>
  </div>

  <!-- ============ ECOSYSTEM VISUAL ============ -->
  <div class="card" style="text-align: center;">
    <h2 style="margin-bottom: 4px;">The Ecosystem</h2>
    <p style="font-size: 0.82rem; opacity: 0.6; margin-bottom: 16px;">Every piece feeds the next. Here's how it all connects.</p>
    <div class="ecosystem-circle">
      <div class="eco-ring"></div>
      <div class="eco-center-arrow">&#8635;</div>
      <div class="eco-node">Essay</div>
      <div class="eco-node">Notes</div>
      <div class="eco-node">LinkedIn + IG</div>
      <div class="eco-node">Landing Page</div>
      <div class="eco-node">Email List</div>
      <div class="eco-node">Substack</div>
    </div>
  </div>

  <!-- ============ PILLAR 1: SUBSTACK ============ -->
  <div class="card">
    <div class="pillar-label">Pillar 1</div>
    <h2>Substack - Weekly Tasks</h2>

    <div class="task-row" data-key="substack-essay">
      <label>
        <input type="checkbox" data-task="substack-essay">
        <span>Long-form essay published (biweekly)</span>
      </label>
    </div>

    <div class="essay-tracker-panel" id="essayTrackerPanel">
      <div class="tracker-field">
        <label for="essayTitle">Essay title</label>
        <input type="text" id="essayTitle" placeholder="What's this one called?">
      </div>
      <div class="tracker-field">
        <label for="essaySubtitle">Essay subtitle</label>
        <input type="text" id="essaySubtitle" placeholder="Subtitle or tagline">
      </div>
      <div class="tracker-field">
        <label>How'd it feel? (1-5)</label>
        <div class="star-rating" id="essayRating">
          <button type="button" class="star" data-star="1">&#9733;</button>
          <button type="button" class="star" data-star="2">&#9733;</button>
          <button type="button" class="star" data-star="3">&#9733;</button>
          <button type="button" class="star" data-star="4">&#9733;</button>
          <button type="button" class="star" data-star="5">&#9733;</button>
        </div>
      </div>
      <button type="button" class="essay-submit-btn" id="essaySubmitBtn">Save to Essay Log</button>
    </div>

    <div style="padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.04);">
      <div style="font-size: 0.93rem; margin-bottom: 4px;">Substack Notes</div>
      <div class="day-checkboxes">
        <div class="day-check"><span>M</span><input type="checkbox" data-task="substack-notes-mon"></div>
        <div class="day-check"><span>T</span><input type="checkbox" data-task="substack-notes-tue"></div>
        <div class="day-check"><span>W</span><input type="checkbox" data-task="substack-notes-wed"></div>
        <div class="day-check"><span>Th</span><input type="checkbox" data-task="substack-notes-thu"></div>
        <div class="day-check"><span>F</span><input type="checkbox" data-task="substack-notes-fri"></div>
        <div class="day-check"><span>S</span><input type="checkbox" data-task="substack-notes-sat"></div>
        <div class="day-check"><span>Su</span><input type="checkbox" data-task="substack-notes-sun"></div>
      </div>
    </div>

    <div class="counter-row" data-key="substack-comments">
      <span class="counter-label">Commented on other Substacks</span>
      <div class="counter-controls">
        <button class="counter-btn" data-action="dec" data-counter="substack-comments">-</button>
        <span class="counter-val" data-display="substack-comments">0</span>
        <button class="counter-btn" data-action="inc" data-counter="substack-comments">+</button>
        <span class="counter-aim">/ 5</span>
      </div>
    </div>

    <div class="task-row" data-key="substack-collab">
      <label>
        <input type="checkbox" data-task="substack-collab">
        <span>Collaboration initiated (monthly)</span>
      </label>
    </div>

    <div id="custom-substack-weekly"></div>
    <div class="add-task-row">
      <input type="text" class="add-task-input" placeholder="+ Add task" data-section="substack-weekly" maxlength="120">
      <button class="add-task-btn" data-section="substack-weekly">Add</button>
    </div>

    <button type="button" class="prompt-btn" data-prompt="substack-notes">Generate Note Ideas</button>
    <div class="chat-panel" data-chat="substack-notes">
      <div class="chat-header"><button type="button" class="chat-close-btn">Close chat</button></div>
      <div class="chat-messages"></div>
      <div class="chat-input-row">
        <textarea class="chat-essay-input" placeholder="Paste your essay here..."></textarea>
        <button type="button" class="chat-send-btn">Send</button>
      </div>
    </div>
  </div>

  <!-- ============ PILLAR 2: LINKEDIN ============ -->
  <div class="card">
    <div class="pillar-label">Pillar 2</div>
    <h2>LinkedIn - Weekly Tasks</h2>

    <div class="counter-row">
      <span class="counter-label">Posts this week</span>
      <div class="counter-controls">
        <button class="counter-btn" data-action="dec" data-counter="linkedin-posts">-</button>
        <span class="counter-val" data-display="linkedin-posts">0</span>
        <button class="counter-btn" data-action="inc" data-counter="linkedin-posts">+</button>
        <span class="counter-aim">/ 2</span>
      </div>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-task="linkedin-engagement">
        <span>Meaningful engagement on other posts</span>
      </label>
    </div>

    <div id="custom-linkedin-weekly"></div>
    <div class="add-task-row">
      <input type="text" class="add-task-input" placeholder="+ Add task" data-section="linkedin-weekly" maxlength="120">
      <button class="add-task-btn" data-section="linkedin-weekly">Add</button>
    </div>

    <button type="button" class="prompt-btn" data-prompt="linkedin-posts">Generate Post Ideas</button>
    <div class="chat-panel" data-chat="linkedin-posts">
      <div class="chat-header"><button type="button" class="chat-close-btn">Close chat</button></div>
      <div class="chat-messages"></div>
      <div class="chat-input-row">
        <textarea class="chat-essay-input" placeholder="Paste your essay here..."></textarea>
        <button type="button" class="chat-send-btn">Send</button>
      </div>
    </div>
  </div>

  <!-- ============ PILLAR 3: INSTAGRAM ============ -->
  <div class="card">
    <div class="pillar-label">Pillar 3</div>
    <h2>Instagram - Weekly Tasks</h2>

    <div class="task-row">
      <label>
        <input type="checkbox" data-task="ig-carousel">
        <span>Instagram carousel created from essay</span>
      </label>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-task="ig-stories">
        <span>Instagram stories posted</span>
      </label>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-task="ig-engagement">
        <span>Meaningful engagement on other posts/accounts</span>
      </label>
    </div>

    <div id="custom-ig-weekly"></div>
    <div class="add-task-row">
      <input type="text" class="add-task-input" placeholder="+ Add task" data-section="ig-weekly" maxlength="120">
      <button class="add-task-btn" data-section="ig-weekly">Add</button>
    </div>

    <button type="button" class="prompt-btn" data-prompt="ig-carousel">Generate Carousel Ideas</button>
    <div class="chat-panel" data-chat="ig-carousel">
      <div class="chat-header"><button type="button" class="chat-close-btn">Close chat</button></div>
      <div class="chat-messages"></div>
      <div class="chat-input-row">
        <textarea class="chat-essay-input" placeholder="Paste your essay here..."></textarea>
        <button type="button" class="chat-send-btn">Send</button>
      </div>
    </div>
  </div>

  <!-- ============ WEEKLY ACTIONS ============ -->
  <div class="card">
    <div class="footer-actions" style="text-align: center;">
      <button class="btn-primary" id="submitWeekBtn">Submit Week</button>
      <button class="btn-secondary" id="shareBtn">Share My Progress</button>
      <button class="btn-secondary" id="progressLogBtn">View Progress Log</button>
    </div>
  </div>

  <!-- ============ STATS CHECKPOINTS ============ -->
  <div class="card">
    <div class="collapsible-header" data-collapse="stats-body">
      <h2>Stats Checkpoints</h2>
      <span class="collapse-icon">&#9660;</span>
    </div>
    <div class="collapsible-body" id="stats-body">
      <p style="font-size: 0.82rem; opacity: 0.6; margin-bottom: 14px;">Enter your numbers at three points to see growth over time.</p>

      <div style="overflow-x: auto;">
        <table class="stats-table">
          <thead>
            <tr>
              <th style="text-align:left; min-width: 140px;"></th>
              <th>Beginning<br><span style="font-weight:400; font-size:0.65rem;">Month 1</span></th>
              <th>Midpoint<br><span style="font-weight:400; font-size:0.65rem;">Month 3</span></th>
              <th>End<br><span style="font-weight:400; font-size:0.65rem;">Month 6</span></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Substack subscribers</td>
              <td><input type="text" class="stats-input" data-stat="sub-subscribers-1" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="sub-subscribers-2" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="sub-subscribers-3" inputmode="numeric"></td>
            </tr>
            <tr>
              <td>Substack followers</td>
              <td><input type="text" class="stats-input" data-stat="sub-followers-1" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="sub-followers-2" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="sub-followers-3" inputmode="numeric"></td>
            </tr>
            <tr>
              <td>Substack open rate %</td>
              <td><input type="text" class="stats-input" data-stat="sub-openrate-1" inputmode="decimal"></td>
              <td><input type="text" class="stats-input" data-stat="sub-openrate-2" inputmode="decimal"></td>
              <td><input type="text" class="stats-input" data-stat="sub-openrate-3" inputmode="decimal"></td>
            </tr>
            <tr>
              <td>LinkedIn followers</td>
              <td><input type="text" class="stats-input" data-stat="li-followers-1" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="li-followers-2" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="li-followers-3" inputmode="numeric"></td>
            </tr>
            <tr>
              <td>LinkedIn profile views</td>
              <td><input type="text" class="stats-input" data-stat="li-views-1" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="li-views-2" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="li-views-3" inputmode="numeric"></td>
            </tr>
            <tr>
              <td>Instagram followers</td>
              <td><input type="text" class="stats-input" data-stat="ig-followers-1" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="ig-followers-2" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="ig-followers-3" inputmode="numeric"></td>
            </tr>
            <tr>
              <td>Email list size</td>
              <td><input type="text" class="stats-input" data-stat="email-list-1" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="email-list-2" inputmode="numeric"></td>
              <td><input type="text" class="stats-input" data-stat="email-list-3" inputmode="numeric"></td>
            </tr>
            <tr>
              <td></td>
              <td style="text-align:center; padding-top: 10px;"><button type="button" class="stats-lock-btn" data-lock-col="1">&#128275; Lock</button></td>
              <td style="text-align:center; padding-top: 10px;"><button type="button" class="stats-lock-btn" data-lock-col="2">&#128275; Lock</button></td>
              <td style="text-align:center; padding-top: 10px;"><button type="button" class="stats-lock-btn" data-lock-col="3">&#128275; Lock</button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ============ PILLARS 4 & 5: SIDE BY SIDE ============ -->
  <div class="card-row">

  <!-- ============ PILLAR 4: LANDING PAGE ============ -->
  <div class="card">
    <div class="pillar-label">Pillar 4</div>
    <h2>Landing Page - Milestones</h2>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="lp-drafted">
        <span>Landing page layout, design, and copy drafted</span>
      </label>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="lp-live">
        <span>Landing page live</span>
      </label>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="lp-email-capture">
        <span>Email capture & delivery system set up</span>
      </label>
    </div>

    <div id="custom-landing-page"></div>
    <div class="add-task-row">
      <input type="text" class="add-task-input" placeholder="+ Add task" data-section="landing-page" maxlength="120">
      <button class="add-task-btn" data-section="landing-page">Add</button>
    </div>
  </div>

  <!-- ============ PILLAR 5: LEAD MAGNET ============ -->
  <div class="card">
    <div class="pillar-label">Pillar 5</div>
    <h2>Lead Magnet - Milestones</h2>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="lm-topic">
        <span>Lead magnet topic chosen</span>
      </label>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="lm-draft">
        <span>Lead magnet draft complete</span>
      </label>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="lm-designed">
        <span>Lead magnet designed</span>
      </label>
    </div>

    <button type="button" class="prompt-btn" data-prompt="lead-magnet">Generate Lead Magnet Ideas</button>
    <div class="chat-panel" data-chat="lead-magnet">
      <div class="chat-header"><button type="button" class="chat-close-btn">Close chat</button></div>
      <div class="chat-messages"></div>
      <div class="chat-input-row">
        <textarea class="chat-essay-input" placeholder="Paste your essay here..."></textarea>
        <button type="button" class="chat-send-btn">Send</button>
      </div>
    </div>

    <div id="custom-lead-magnet"></div>
    <div class="add-task-row">
      <input type="text" class="add-task-input" placeholder="+ Add task" data-section="lead-magnet" maxlength="120">
      <button class="add-task-btn" data-section="lead-magnet">Add</button>
    </div>
  </div>

  </div><!-- /card-row -->

  <!-- ============ VISIBILITY & OUTREACH ============ -->
  <div class="card">
    <h2>Visibility & Outreach - Milestones</h2>

    <!-- Phase 1 -->
    <div class="collapsible-section">
      <div class="collapsible-header" data-collapse="outreach-p1">
        <h3>Phase 1: Foundation</h3>
        <span class="collapse-icon">&#9660;</span>
      </div>
      <div class="collapsible-body" id="outreach-p1">
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-calendar">
            <span>Content calendar created</span>
          </label>
        </div>
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-podcast-list">
            <span>Collaboration list built</span>
          </label>
        </div>
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-template">
            <span>Outreach template drafted</span>
          </label>
        </div>
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-first5">
            <span>First 5 outreach emails sent</span>
          </label>
        </div>
        <div id="custom-outreach-p1"></div>
        <div class="add-task-row">
          <input type="text" class="add-task-input" placeholder="+ Add task" data-section="outreach-p1" maxlength="120">
          <button class="add-task-btn" data-section="outreach-p1">Add</button>
        </div>
      </div>
    </div>

    <!-- Phase 2 -->
    <div class="collapsible-section" style="margin-top: 12px;">
      <div class="collapsible-header" data-collapse="outreach-p2">
        <h3>Phase 2: Momentum</h3>
        <span class="collapse-icon">&#9660;</span>
      </div>
      <div class="collapsible-body" id="outreach-p2">
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-book-podcast">
            <span>Book 1 podcast appearance</span>
          </label>
        </div>
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-guest-post">
            <span>Secure 1 guest post</span>
          </label>
        </div>
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-pitch3">
            <span>Pitch 3+ media outlets</span>
          </label>
        </div>
        <div class="task-row">
          <label>
            <input type="checkbox" data-milestone="outreach-followup">
            <span>Follow up on all outstanding outreach</span>
          </label>
        </div>
        <div id="custom-outreach-p2"></div>
        <div class="add-task-row">
          <input type="text" class="add-task-input" placeholder="+ Add task" data-section="outreach-p2" maxlength="120">
          <button class="add-task-btn" data-section="outreach-p2">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ BOOK CLARITY ============ -->
  <div class="card">
    <h2>Book Clarity - Milestones</h2>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="book-thesis">
        <span>Working thesis drafted</span>
      </label>
    </div>

    <div class="task-row">
      <label>
        <input type="checkbox" data-milestone="book-chapters">
        <span>Rough chapter list created</span>
      </label>
    </div>

    <div id="custom-book"></div>
    <div class="add-task-row">
      <input type="text" class="add-task-input" placeholder="+ Add task" data-section="book" maxlength="120">
      <button class="add-task-btn" data-section="book">Add</button>
    </div>
  </div>

</div>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<!-- Progress Log modal -->
<div class="modal-overlay" id="progressLogModal">
  <div class="modal-content">
    <h3>Progress Log</h3>
    <div id="progressLogEntries"></div>
    <button type="button" class="modal-close" id="progressLogClose">Close</button>
  </div>
</div>

<!-- Submit Week dialog -->
<div class="dialog-overlay" id="submitWeekDialog">
  <div class="dialog-box dialog-wide">
    <h3>Submit this week?</h3>
    <div id="submitWeekPreview"></div>
    <div class="submit-reflection-label">What was your biggest win or insight this week?</div>
    <textarea class="submit-reflection-textarea" id="submitReflection" placeholder="One sentence is plenty." rows="2"></textarea>
    <div class="dialog-buttons">
      <button class="dialog-cancel" id="submitWeekCancel">Cancel</button>
      <button class="dialog-confirm" id="submitWeekConfirm">Submit & Start Fresh</button>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ============ DATA LAYER ============
  const STORAGE_KEY = 'alittlewoo_data';

  const WEEKLY_TASKS = [
    'substack-essay', 'substack-notes-mon', 'substack-notes-tue', 'substack-notes-wed',
    'substack-notes-thu', 'substack-notes-fri', 'substack-notes-sat', 'substack-notes-sun',
    'substack-collab', 'linkedin-engagement', 'ig-carousel', 'ig-stories', 'ig-engagement'
  ];

  const WEEKLY_COUNTERS = ['substack-comments', 'linkedin-posts'];

  const WEEKLY_CUSTOM_SECTIONS = ['substack-weekly', 'linkedin-weekly', 'ig-weekly'];
  const MILESTONE_CUSTOM_SECTIONS = ['landing-page', 'lead-magnet', 'outreach-p1', 'outreach-p2', 'book'];

  function defaultData() {
    return {
      tasks: {},
      milestones: {},
      counters: {},
      stats: {},
      customTasks: {},
      collapsed: {},
      essayLog: [],
      statsLocked: {},
      weeklyWins: [],
      progressLog: []
    };
  }

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return defaultData();
      const parsed = JSON.parse(raw);
      // Merge with defaults for forward compatibility
      const d = defaultData();
      return {
        tasks: parsed.tasks || d.tasks,
        milestones: parsed.milestones || d.milestones,
        counters: parsed.counters || d.counters,
        stats: parsed.stats || d.stats,
        customTasks: parsed.customTasks || d.customTasks,
        collapsed: parsed.collapsed || d.collapsed,
        essayLog: parsed.essayLog || d.essayLog,
        statsLocked: parsed.statsLocked || d.statsLocked,
        weeklyWins: parsed.weeklyWins || d.weeklyWins,
        progressLog: parsed.progressLog || d.progressLog
      };
    } catch (e) {
      return defaultData();
    }
  }

  function save(data) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      // storage full or unavailable
    }
  }

  let data = load();

  // ============ PRIVATE BROWSING DETECTION ============
  function detectPrivateBrowsing() {
    try {
      const testKey = '__alittlewoo_test__';
      localStorage.setItem(testKey, '1');
      localStorage.removeItem(testKey);
    } catch (e) {
      document.getElementById('privateWarning').style.display = 'block';
    }
  }
  detectPrivateBrowsing();

  // ============ TIMELINE ============
  function updateTimeline() {
    const start = new Date(2026, 0, 21); // Jan 21, 2026
    const end = new Date(2026, 6, 21);   // Jul 21, 2026
    const now = new Date();
    const total = end - start;
    const elapsed = now - start;
    let pct = Math.max(0, Math.min(100, (elapsed / total) * 100));
    pct = Math.round(pct);

    document.getElementById('timelineFill').style.width = pct + '%';
    document.getElementById('timelinePercent').textContent = pct + '%';
  }
  updateTimeline();

  // ============ RESTORE STATE ============
  function restoreState() {
    // Weekly tasks
    document.querySelectorAll('[data-task]').forEach(function(el) {
      const key = el.getAttribute('data-task');
      if (data.tasks[key]) {
        el.checked = true;
        var row = el.closest('.task-row');
        if (row) row.classList.add('completed');
      }
    });

    // Milestones
    document.querySelectorAll('[data-milestone]').forEach(function(el) {
      const key = el.getAttribute('data-milestone');
      if (data.milestones[key]) {
        el.checked = true;
        var row = el.closest('.task-row');
        if (row) row.classList.add('completed');
      }
    });

    // Counters
    document.querySelectorAll('[data-display]').forEach(function(el) {
      const key = el.getAttribute('data-display');
      el.textContent = data.counters[key] || 0;
    });

    // Stats
    document.querySelectorAll('[data-stat]').forEach(function(el) {
      const key = el.getAttribute('data-stat');
      if (data.stats[key] !== undefined) el.value = data.stats[key];
    });

    // Custom tasks
    Object.keys(data.customTasks).forEach(function(section) {
      const tasks = data.customTasks[section];
      if (tasks && tasks.length) {
        tasks.forEach(function(t) {
          renderCustomTask(section, t.id, t.text, t.done);
        });
      }
    });

    // Collapsed state
    Object.keys(data.collapsed).forEach(function(id) {
      if (data.collapsed[id]) {
        const body = document.getElementById(id);
        if (body) body.classList.add('collapsed');
        const header = document.querySelector('[data-collapse="' + id + '"]');
        if (header) {
          const icon = header.querySelector('.collapse-icon');
          if (icon) icon.style.transform = 'rotate(-90deg)';
        }
      }
    });

    // Stats locked state
    Object.keys(data.statsLocked).forEach(function(col) {
      if (data.statsLocked[col]) {
        applyStatsLock(col, true);
      }
    });

    // Essay tracker panel - open if essay was checked
    if (data.tasks['substack-essay']) {
      var panel = document.getElementById('essayTrackerPanel');
      if (panel) panel.classList.add('open');
    }
  }

  // ============ EVENT HANDLERS ============

  // Weekly task checkboxes
  document.querySelectorAll('[data-task]').forEach(function(el) {
    el.addEventListener('change', function() {
      const key = this.getAttribute('data-task');
      data.tasks[key] = this.checked;
      var row = this.closest('.task-row');
      if (row) row.classList.toggle('completed', this.checked);
      save(data);
    });
  });

  // Milestone checkboxes
  document.querySelectorAll('[data-milestone]').forEach(function(el) {
    el.addEventListener('change', function() {
      const key = this.getAttribute('data-milestone');
      data.milestones[key] = this.checked;
      var row = this.closest('.task-row');
      if (row) row.classList.toggle('completed', this.checked);
      save(data);
    });
  });

  // Counter buttons
  document.querySelectorAll('.counter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const key = this.getAttribute('data-counter');
      const action = this.getAttribute('data-action');
      let val = data.counters[key] || 0;
      if (action === 'inc') val++;
      else if (action === 'dec' && val > 0) val--;
      data.counters[key] = val;
      document.querySelector('[data-display="' + key + '"]').textContent = val;
      save(data);
    });
  });

  // Stats inputs
  document.querySelectorAll('[data-stat]').forEach(function(el) {
    el.addEventListener('input', function() {
      const key = this.getAttribute('data-stat');
      data.stats[key] = this.value;
      save(data);
    });
  });

  // Collapsible sections
  document.querySelectorAll('.collapsible-header').forEach(function(header) {
    header.addEventListener('click', function() {
      const targetId = this.getAttribute('data-collapse');
      const body = document.getElementById(targetId);
      const icon = this.querySelector('.collapse-icon');
      if (body) {
        const isCollapsed = body.classList.toggle('collapsed');
        data.collapsed[targetId] = isCollapsed;
        if (icon) icon.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
        save(data);
      }
    });
  });

  // ============ CUSTOM TASKS ============
  let customIdCounter = Date.now();

  function renderCustomTask(section, id, text, done) {
    const isMilestone = MILESTONE_CUSTOM_SECTIONS.indexOf(section) !== -1;
    const container = document.getElementById('custom-' + section);
    if (!container) return;

    const row = document.createElement('div');
    row.className = 'task-row' + (done ? ' completed' : '');
    row.setAttribute('data-custom-id', id);

    const label = document.createElement('label');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = !!done;
    if (done) row.classList.add('completed');

    checkbox.addEventListener('change', function() {
      row.classList.toggle('completed', this.checked);
      // Update in data
      var arr = data.customTasks[section] || [];
      for (var i = 0; i < arr.length; i++) {
        if (arr[i].id === id) { arr[i].done = this.checked; break; }
      }
      save(data);
    });

    const span = document.createElement('span');
    span.textContent = text;

    label.appendChild(checkbox);
    label.appendChild(span);

    const delBtn = document.createElement('button');
    delBtn.className = 'custom-task-delete';
    delBtn.innerHTML = '&times;';
    delBtn.title = 'Remove task';
    delBtn.addEventListener('click', function() {
      row.remove();
      var arr = data.customTasks[section] || [];
      data.customTasks[section] = arr.filter(function(t) { return t.id !== id; });
      save(data);
    });

    row.appendChild(label);
    row.appendChild(delBtn);
    container.appendChild(row);
  }

  function addCustomTask(section, text) {
    text = text.trim();
    if (!text) return;
    const id = 'c' + (++customIdCounter);
    if (!data.customTasks[section]) data.customTasks[section] = [];
    data.customTasks[section].push({ id: id, text: text, done: false });
    renderCustomTask(section, id, text, false);
    save(data);
  }

  // Add task buttons
  document.querySelectorAll('.add-task-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const section = this.getAttribute('data-section');
      const input = this.previousElementSibling;
      addCustomTask(section, input.value);
      input.value = '';
    });
  });

  // Enter key on add task inputs
  document.querySelectorAll('.add-task-input').forEach(function(input) {
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        const section = this.getAttribute('data-section');
        addCustomTask(section, this.value);
        this.value = '';
      }
    });
  });

  // ============ ESSAY TRACKER ============
  var essayCheckbox = document.querySelector('[data-task="substack-essay"]');
  var essayPanel = document.getElementById('essayTrackerPanel');
  var currentEssayRating = 0;

  if (essayCheckbox && essayPanel) {
    essayCheckbox.addEventListener('change', function() {
      if (this.checked) {
        essayPanel.classList.add('open');
      } else {
        essayPanel.classList.remove('open');
      }
    });
  }

  // Star rating
  document.querySelectorAll('#essayRating .star').forEach(function(star) {
    star.addEventListener('click', function() {
      currentEssayRating = parseInt(this.getAttribute('data-star'));
      updateStarDisplay(currentEssayRating);
    });
  });

  function updateStarDisplay(rating) {
    document.querySelectorAll('#essayRating .star').forEach(function(star) {
      var val = parseInt(star.getAttribute('data-star'));
      star.classList.toggle('active', val <= rating);
    });
  }

  // Submit essay to log
  document.getElementById('essaySubmitBtn').addEventListener('click', function() {
    var title = document.getElementById('essayTitle').value.trim();
    var subtitle = document.getElementById('essaySubtitle').value.trim();
    if (!title) {
      showToast('Add a title first!');
      return;
    }
    var entry = {
      title: title,
      subtitle: subtitle,
      rating: currentEssayRating,
      date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
    };
    data.essayLog.push(entry);
    save(data);
    document.getElementById('essayTitle').value = '';
    document.getElementById('essaySubtitle').value = '';
    currentEssayRating = 0;
    updateStarDisplay(0);
    showToast('Essay saved!');
  });

  // ============ SUBMIT WEEK ============
  function buildWeekSnapshot() {
    // Compute task completion count
    var tasksCompleted = 0;
    var tasksTotal = WEEKLY_TASKS.length;
    var taskStates = {};
    WEEKLY_TASKS.forEach(function(key) {
      var done = !!data.tasks[key];
      taskStates[key] = done;
      if (done) tasksCompleted++;
    });

    // Counter values
    var counterValues = {};
    WEEKLY_COUNTERS.forEach(function(key) {
      counterValues[key] = data.counters[key] || 0;
    });

    // Custom tasks snapshot (weekly sections only)
    var customTasksSnapshot = {};
    WEEKLY_CUSTOM_SECTIONS.forEach(function(section) {
      var tasks = data.customTasks[section] || [];
      customTasksSnapshot[section] = tasks.map(function(t) {
        return { text: t.text, done: t.done };
      });
      // Count custom tasks
      tasks.forEach(function(t) {
        tasksTotal++;
        if (t.done) tasksCompleted++;
      });
    });

    // Notes days string
    var notesDays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    var notesKeys = ['substack-notes-mon','substack-notes-tue','substack-notes-wed','substack-notes-thu','substack-notes-fri','substack-notes-sat','substack-notes-sun'];
    var notesDayStr = notesDays.map(function(d, i) {
      return data.tasks[notesKeys[i]] ? d : '_';
    }).join(' ');

    // Essay: grab from essayLog if the essay checkbox is checked and there's a recent entry
    var essay = null;
    if (data.tasks['substack-essay'] && data.essayLog.length > 0) {
      var latest = data.essayLog[data.essayLog.length - 1];
      essay = { title: latest.title, subtitle: latest.subtitle, rating: latest.rating };
    }

    // Summary line
    var summaryLine = tasksCompleted + '/' + tasksTotal + ' tasks';
    summaryLine += ' \u00B7 ' + counterValues['substack-comments'] + '/5 comments';
    summaryLine += ' \u00B7 ' + counterValues['linkedin-posts'] + '/2 posts';

    return {
      dateLabel: new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }),
      tasks: taskStates,
      counters: counterValues,
      customTasks: customTasksSnapshot,
      summary: {
        line: summaryLine,
        tasksCompleted: tasksCompleted,
        tasksTotal: tasksTotal,
        notesDays: notesDayStr
      },
      reflection: '',
      essay: essay
    };
  }

  function renderPillarDetail(name, items, customTasks) {
    var html = '<div class="submit-pillar">';
    html += '<div class="submit-pillar-name">' + escapeHtml(name) + '</div>';
    html += '<div class="submit-pillar-items">';
    items.forEach(function(item) {
      var cls = item.done ? 'item-done' : 'item-not-done';
      var mark = item.done ? '\u2713' : '\u2717';
      html += '<div class="' + cls + '">' + mark + ' ' + escapeHtml(item.label) + '</div>';
    });
    if (customTasks && customTasks.length) {
      customTasks.forEach(function(t) {
        var cls = t.done ? 'item-done' : 'item-not-done';
        var mark = t.done ? '\u2713' : '\u2717';
        html += '<div class="' + cls + '">' + mark + ' ' + escapeHtml(t.text) + '</div>';
      });
    }
    html += '</div></div>';
    return html;
  }

  function renderSubmitPreview(snapshot) {
    var html = '';
    html += '<div class="submit-summary-banner">' + escapeHtml(snapshot.summary.line) + '</div>';

    // Substack
    html += renderPillarDetail('Substack', [
      { label: 'Long-form essay published', done: snapshot.tasks['substack-essay'] },
      { label: 'Notes: ' + snapshot.summary.notesDays, done: true },
      { label: 'Comments on other Substacks: ' + snapshot.counters['substack-comments'] + '/5', done: snapshot.counters['substack-comments'] > 0 },
      { label: 'Collaboration initiated', done: snapshot.tasks['substack-collab'] }
    ], snapshot.customTasks['substack-weekly']);

    // LinkedIn
    html += renderPillarDetail('LinkedIn', [
      { label: 'Posts this week: ' + snapshot.counters['linkedin-posts'] + '/2', done: snapshot.counters['linkedin-posts'] > 0 },
      { label: 'Meaningful engagement', done: snapshot.tasks['linkedin-engagement'] }
    ], snapshot.customTasks['linkedin-weekly']);

    // Instagram
    html += renderPillarDetail('Instagram', [
      { label: 'Carousel created from essay', done: snapshot.tasks['ig-carousel'] },
      { label: 'Stories posted', done: snapshot.tasks['ig-stories'] },
      { label: 'Meaningful engagement', done: snapshot.tasks['ig-engagement'] }
    ], snapshot.customTasks['ig-weekly']);

    // Essay card
    if (snapshot.essay) {
      var stars = '';
      for (var s = 0; s < 5; s++) stars += s < snapshot.essay.rating ? '\u2605' : '\u2606';
      html += '<div class="submit-essay-card">';
      html += '<div class="essay-card-title">' + escapeHtml(snapshot.essay.title) + '</div>';
      if (snapshot.essay.subtitle) html += '<div class="essay-card-meta">' + escapeHtml(snapshot.essay.subtitle) + '</div>';
      html += '<div class="essay-card-meta">' + stars + '</div>';
      html += '</div>';
    }

    return html;
  }

  var submitWeekDialog = document.getElementById('submitWeekDialog');
  var currentSnapshot = null;

  document.getElementById('submitWeekBtn').addEventListener('click', function() {
    currentSnapshot = buildWeekSnapshot();
    document.getElementById('submitWeekPreview').innerHTML = renderSubmitPreview(currentSnapshot);
    document.getElementById('submitReflection').value = '';
    submitWeekDialog.classList.add('active');
  });

  document.getElementById('submitWeekCancel').addEventListener('click', function() {
    submitWeekDialog.classList.remove('active');
  });

  submitWeekDialog.addEventListener('click', function(e) {
    if (e.target === submitWeekDialog) submitWeekDialog.classList.remove('active');
  });

  document.getElementById('submitWeekConfirm').addEventListener('click', function() {
    if (!currentSnapshot) return;

    // Capture reflection
    currentSnapshot.reflection = document.getElementById('submitReflection').value.trim();

    // Save to progress log
    data.progressLog.push(currentSnapshot);

    // Reset weekly tasks
    WEEKLY_TASKS.forEach(function(key) {
      data.tasks[key] = false;
      var el = document.querySelector('[data-task="' + key + '"]');
      if (el) {
        el.checked = false;
        var row = el.closest('.task-row');
        if (row) row.classList.remove('completed');
      }
    });

    // Reset weekly counters
    WEEKLY_COUNTERS.forEach(function(key) {
      data.counters[key] = 0;
      var display = document.querySelector('[data-display="' + key + '"]');
      if (display) display.textContent = '0';
    });

    // Clear custom tasks in weekly sections
    WEEKLY_CUSTOM_SECTIONS.forEach(function(section) {
      data.customTasks[section] = [];
      var container = document.getElementById('custom-' + section);
      if (container) container.innerHTML = '';
    });

    // Close essay tracker panel and clear fields
    var essayPanelEl = document.getElementById('essayTrackerPanel');
    if (essayPanelEl) essayPanelEl.classList.remove('open');
    document.getElementById('essayTitle').value = '';
    document.getElementById('essaySubtitle').value = '';
    currentEssayRating = 0;
    updateStarDisplay(0);

    save(data);
    submitWeekDialog.classList.remove('active');
    currentSnapshot = null;
    showToast('Week submitted! Keep going.');
  });

  // ============ PROMPT BUTTONS & INLINE CHAT ============
  var BUTTON_LABELS = {
    'substack-notes': 'Generate Note Ideas',
    'linkedin-posts': 'Generate Post Ideas',
    'ig-carousel': 'Generate Carousel Ideas',
    'lead-magnet': 'Generate Lead Magnet Ideas'
  };

  // Chat state per panel (in memory, not localStorage)
  var chatStates = {};

  function getChatState(promptKey) {
    if (!chatStates[promptKey]) {
      chatStates[promptKey] = { messages: [], streaming: false };
    }
    return chatStates[promptKey];
  }

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(function() {
        showToast('Copied!');
      }).catch(function() {
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }

  // Lightweight markdown: bold, italic, line breaks, paragraphs
  function simpleMarkdown(text) {
    // Split into paragraphs on double newline
    var paragraphs = text.split(/\n{2,}/);
    return paragraphs.map(function(para) {
      var safe = escapeHtml(para.trim());
      // Bold **text**
      safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      // Italic *text*
      safe = safe.replace(/\*(.+?)\*/g, '<em>$1</em>');
      // Single newlines to <br>
      safe = safe.replace(/\n/g, '<br>');
      return '<p>' + safe + '</p>';
    }).join('');
  }

  function truncateEssay(text, maxLen) {
    if (text.length <= maxLen) return text;
    return text.substring(0, maxLen) + '... [essay continues]';
  }

  function renderUserMessage(panel, text) {
    var container = panel.querySelector('.chat-messages');
    var div = document.createElement('div');
    div.className = 'chat-msg chat-msg-user';
    div.innerHTML = '<div class="chat-msg-label">You</div><div class="chat-msg-content">' + escapeHtml(truncateEssay(text, 300)) + '</div>';
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function createAssistantMessageEl(panel) {
    var container = panel.querySelector('.chat-messages');
    var div = document.createElement('div');
    div.className = 'chat-msg chat-msg-assistant';
    div.innerHTML = '<div class="chat-msg-content"><span class="chat-cursor"></span></div>';
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div;
  }

  function updateAssistantMessage(el, text) {
    var content = el.querySelector('.chat-msg-content');
    content.innerHTML = simpleMarkdown(text) + '<span class="chat-cursor"></span>';
    var container = el.closest('.chat-messages');
    if (container) container.scrollTop = container.scrollHeight;
  }

  function finalizeAssistantMessage(el, text) {
    var content = el.querySelector('.chat-msg-content');
    content.innerHTML = simpleMarkdown(text);
    // Add copy button
    var copyBtn = document.createElement('button');
    copyBtn.type = 'button';
    copyBtn.className = 'chat-copy-btn';
    copyBtn.textContent = 'Copy';
    copyBtn.addEventListener('click', function() {
      copyToClipboard(text);
    });
    el.appendChild(copyBtn);
    var container = el.closest('.chat-messages');
    if (container) container.scrollTop = container.scrollHeight;
  }

  function showChatError(panel, msg) {
    var container = panel.querySelector('.chat-messages');
    var div = document.createElement('div');
    div.className = 'chat-error';
    div.textContent = msg || 'Something went wrong. Try again.';
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  function switchToFollowUp(panel) {
    var inputRow = panel.querySelector('.chat-input-row');
    inputRow.innerHTML = '';
    var input = document.createElement('textarea');
    input.className = 'chat-followup-input';
    input.placeholder = 'Ask a follow-up (e.g. "try a different angle", "write option 2 in full")...';
    input.rows = 1;
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chat-send-btn';
    btn.textContent = 'Send';
    inputRow.appendChild(input);
    inputRow.appendChild(btn);

    var promptKey = panel.getAttribute('data-chat');
    btn.addEventListener('click', function() {
      var text = input.value.trim();
      if (!text) return;
      input.value = '';
      sendChatMessage(promptKey, text);
    });
    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        btn.click();
      }
    });
  }

  async function sendChatMessage(promptKey, userText) {
    var panel = document.querySelector('.chat-panel[data-chat="' + promptKey + '"]');
    var state = getChatState(promptKey);
    if (state.streaming) return;

    // Add user message to state
    state.messages.push({ role: 'user', content: userText });

    // Render user message
    renderUserMessage(panel, userText);

    // Disable send button
    var sendBtn = panel.querySelector('.chat-send-btn');
    if (sendBtn) sendBtn.disabled = true;
    state.streaming = true;

    // Create assistant message element
    var assistantEl = createAssistantMessageEl(panel);
    var fullText = '';

    try {
      var response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          promptKey: promptKey,
          messages: state.messages
        })
      });

      if (!response.ok) {
        var errData;
        try { errData = await response.json(); } catch(e) { errData = {}; }
        throw new Error(errData.error || 'Chat unavailable right now.');
      }

      // Parse SSE stream
      var reader = response.body.getReader();
      var decoder = new TextDecoder();
      var buffer = '';

      while (true) {
        var result = await reader.read();
        if (result.done) break;

        buffer += decoder.decode(result.value, { stream: true });
        var lines = buffer.split('\n');
        // Keep the last potentially incomplete line in the buffer
        buffer = lines.pop() || '';

        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (!line.startsWith('data: ')) continue;
          var jsonStr = line.substring(6);
          if (jsonStr === '[DONE]') continue;

          try {
            var event = JSON.parse(jsonStr);
            if (event.type === 'content_block_delta' && event.delta && event.delta.type === 'text_delta') {
              fullText += event.delta.text;
              updateAssistantMessage(assistantEl, fullText);
            }
          } catch (parseErr) {
            // Skip unparseable lines
          }
        }
      }

      // Process any remaining buffer
      if (buffer.trim().startsWith('data: ')) {
        var lastJson = buffer.trim().substring(6);
        if (lastJson !== '[DONE]') {
          try {
            var lastEvent = JSON.parse(lastJson);
            if (lastEvent.type === 'content_block_delta' && lastEvent.delta && lastEvent.delta.type === 'text_delta') {
              fullText += lastEvent.delta.text;
            }
          } catch(e) {}
        }
      }

      if (fullText) {
        state.messages.push({ role: 'assistant', content: fullText });
        finalizeAssistantMessage(assistantEl, fullText);
      } else {
        assistantEl.remove();
        showChatError(panel, 'No response received. Try again.');
        // Remove the user message we added since there's no response
        state.messages.pop();
      }
    } catch (err) {
      assistantEl.remove();
      showChatError(panel, err.message || 'Something went wrong. Try again.');
      // Remove the user message since the request failed
      state.messages.pop();
    }

    state.streaming = false;
    if (sendBtn) sendBtn.disabled = false;

    // After first exchange, switch to follow-up input
    if (state.messages.length >= 2 && panel.querySelector('.chat-essay-input')) {
      switchToFollowUp(panel);
    }
  }

  // Toggle chat panel on prompt button click
  document.querySelectorAll('.prompt-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var key = this.getAttribute('data-prompt');
      var panel = document.querySelector('.chat-panel[data-chat="' + key + '"]');
      if (!panel) return;

      var isOpen = panel.classList.contains('open');
      if (isOpen) {
        panel.classList.remove('open');
        this.classList.remove('active');
        this.textContent = BUTTON_LABELS[key];
      } else {
        panel.classList.add('open');
        this.classList.add('active');
        this.textContent = 'Close Chat';
        // Focus the textarea
        var textarea = panel.querySelector('.chat-essay-input') || panel.querySelector('.chat-followup-input');
        if (textarea) setTimeout(function() { textarea.focus(); }, 300);
      }
    });
  });

  // Send button handlers (initial essay send)
  document.querySelectorAll('.chat-panel').forEach(function(panel) {
    var sendBtn = panel.querySelector('.chat-send-btn');
    var textarea = panel.querySelector('.chat-essay-input');
    var promptKey = panel.getAttribute('data-chat');

    if (sendBtn && textarea) {
      sendBtn.addEventListener('click', function() {
        var text = textarea.value.trim();
        if (!text) return;
        textarea.value = '';
        sendChatMessage(promptKey, text);
      });
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          sendBtn.click();
        }
      });
    }
  });

  // Close button handlers
  document.querySelectorAll('.chat-close-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var panel = this.closest('.chat-panel');
      if (!panel) return;
      var key = panel.getAttribute('data-chat');
      panel.classList.remove('open');
      var promptBtn = document.querySelector('.prompt-btn[data-prompt="' + key + '"]');
      if (promptBtn) {
        promptBtn.classList.remove('active');
        promptBtn.textContent = BUTTON_LABELS[key];
      }
    });
  });

  // ============ STATS LOCK ============
  function applyStatsLock(col, locked) {
    document.querySelectorAll('[data-stat$="-' + col + '"]').forEach(function(input) {
      if (locked) {
        input.classList.add('locked');
        input.readOnly = true;
      } else {
        input.classList.remove('locked');
        input.readOnly = false;
      }
    });
    var btn = document.querySelector('[data-lock-col="' + col + '"]');
    if (btn) {
      btn.innerHTML = locked ? '&#128274; Locked' : '&#128275; Lock';
      btn.classList.toggle('locked', locked);
    }
  }

  document.querySelectorAll('.stats-lock-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var col = this.getAttribute('data-lock-col');
      var isLocked = !!data.statsLocked[col];
      data.statsLocked[col] = !isLocked;
      applyStatsLock(col, !isLocked);
      save(data);
    });
  });

  // ============ PROGRESS LOG MODAL ============
  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function renderProgressLog() {
    var container = document.getElementById('progressLogEntries');
    var entries = data.progressLog || [];
    if (entries.length === 0) {
      container.innerHTML = '<div class="progress-empty">No weeks submitted yet. Complete your first week and hit Submit!</div>';
      return;
    }
    var html = '';
    for (var i = entries.length - 1; i >= 0; i--) {
      var entry = entries[i];
      html += '<div class="progress-entry" data-log-index="' + i + '">';

      // Header row (clickable)
      html += '<div class="progress-entry-header">';
      html += '<div>';
      html += '<div class="progress-entry-date">' + escapeHtml(entry.dateLabel) + '</div>';
      html += '<div class="progress-entry-summary">' + escapeHtml(entry.summary.line) + '</div>';
      html += '</div>';
      html += '<span class="progress-entry-arrow">\u25B6</span>';
      html += '</div>';

      // Reflection
      if (entry.reflection) {
        html += '<div class="progress-entry-reflection">\u201C' + escapeHtml(entry.reflection) + '\u201D</div>';
      }

      // Essay
      if (entry.essay) {
        var stars = '';
        for (var s = 0; s < 5; s++) stars += s < entry.essay.rating ? '\u2605' : '\u2606';
        html += '<div class="progress-entry-essay">' + escapeHtml(entry.essay.title) + ' ' + stars + '</div>';
      }

      // Expandable detail
      html += '<div class="progress-entry-detail">';
      html += renderSubmitPreview(entry);
      html += '<div style="text-align:right; margin-top: 10px;"><button type="button" class="progress-entry-delete" data-delete-index="' + i + '">Delete this week</button></div>';
      html += '</div>';

      html += '</div>';
    }
    container.innerHTML = html;

    // Attach expand/collapse handlers
    container.querySelectorAll('.progress-entry-header').forEach(function(header) {
      header.addEventListener('click', function() {
        var entryEl = this.closest('.progress-entry');
        entryEl.classList.toggle('expanded');
      });
    });

    // Attach delete handlers
    container.querySelectorAll('.progress-entry-delete').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var idx = parseInt(this.getAttribute('data-delete-index'));
        if (confirm('Delete this submitted week? This can\u0027t be undone.')) {
          data.progressLog.splice(idx, 1);
          save(data);
          renderProgressLog();
        }
      });
    });
  }

  document.getElementById('progressLogBtn').addEventListener('click', function() {
    renderProgressLog();
    document.getElementById('progressLogModal').classList.add('active');
  });

  document.getElementById('progressLogClose').addEventListener('click', function() {
    document.getElementById('progressLogModal').classList.remove('active');
  });

  document.getElementById('progressLogModal').addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('active');
  });

  // ============ SHARE ============
  function checkMark(val) { return val ? '\u2705' : '\u2B1C'; }

  function generateShareText() {
    var lines = [];
    var date = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    lines.push('A LITTLE WOO \u2728 Weekly Check-In');
    lines.push('Joanne | ' + date);
    lines.push('');

    // Quick summary line
    var tasksCompleted = 0;
    WEEKLY_TASKS.forEach(function(key) { if (data.tasks[key]) tasksCompleted++; });
    WEEKLY_CUSTOM_SECTIONS.forEach(function(section) {
      (data.customTasks[section] || []).forEach(function(t) { if (t.done) tasksCompleted++; });
    });
    var totalTasks = WEEKLY_TASKS.length;
    WEEKLY_CUSTOM_SECTIONS.forEach(function(section) {
      totalTasks += (data.customTasks[section] || []).length;
    });
    lines.push(tasksCompleted + '/' + totalTasks + ' weekly tasks \u00B7 ' + (data.counters['substack-comments'] || 0) + '/5 comments \u00B7 ' + (data.counters['linkedin-posts'] || 0) + '/2 posts');
    lines.push('');

    // Substack
    lines.push('SUBSTACK');
    lines.push(checkMark(data.tasks['substack-essay']) + ' Long-form essay published');
    var notesDays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    var notesKeys = ['substack-notes-mon','substack-notes-tue','substack-notes-wed','substack-notes-thu','substack-notes-fri','substack-notes-sat','substack-notes-sun'];
    var notesStr = notesDays.map(function(d, i) { return data.tasks[notesKeys[i]] ? d : '_'; }).join(' ');
    lines.push('\u270D\uFE0F Notes: ' + notesStr);
    lines.push('\u{1F4AC} Commented on other Substacks: ' + (data.counters['substack-comments'] || 0) + '/5');
    lines.push(checkMark(data.tasks['substack-collab']) + ' Collaboration initiated');
    (data.customTasks['substack-weekly'] || []).forEach(function(t) { lines.push(checkMark(t.done) + ' ' + t.text); });
    lines.push('');

    // LinkedIn
    lines.push('LINKEDIN');
    lines.push('\u{1F4DD} Posts this week: ' + (data.counters['linkedin-posts'] || 0) + '/2');
    lines.push(checkMark(data.tasks['linkedin-engagement']) + ' Meaningful engagement');
    (data.customTasks['linkedin-weekly'] || []).forEach(function(t) { lines.push(checkMark(t.done) + ' ' + t.text); });
    lines.push('');

    // Instagram
    lines.push('INSTAGRAM');
    lines.push(checkMark(data.tasks['ig-carousel']) + ' Carousel created from essay');
    lines.push(checkMark(data.tasks['ig-stories']) + ' Stories posted');
    lines.push(checkMark(data.tasks['ig-engagement']) + ' Meaningful engagement');
    (data.customTasks['ig-weekly'] || []).forEach(function(t) { lines.push(checkMark(t.done) + ' ' + t.text); });
    lines.push('');

    // Prompts
    lines.push('\u2014\u2014\u2014');
    lines.push('');
    lines.push('\u{1F3C6} My win this week:');
    lines.push('[Fill in here]');
    lines.push('');
    lines.push('\u{1F9F1} One thing I\'m stuck on or struggling with:');
    lines.push('[Fill in here]');

    return lines.join('\n');
  }

  document.getElementById('shareBtn').addEventListener('click', function() {
    var text = generateShareText();
    copyToClipboard(text);
    showToast('Copied! Paste into Slack or email.');
  });

  function fallbackCopy(text) {
    var ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    try {
      document.execCommand('copy');
      showToast('Copied!');
    } catch (e) {
      showToast('Could not copy. Try selecting the text manually.');
    }
    document.body.removeChild(ta);
  }

  // ============ TOAST ============
  var toastTimer;
  function showToast(msg) {
    var toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(function() {
      toast.classList.remove('show');
    }, 2200);
  }

  // ============ INIT ============
  restoreState();

})();
</script>
</body>
</html>
